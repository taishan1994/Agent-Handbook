# 1. ä»€ä¹ˆæ˜¯ PocketFlowï¼Ÿ

æ ¹æ®å®˜æ–¹ README ä»‹ç»ï¼šPocket Flow æ˜¯ä¸€ä¸ª 100 è¡Œä»£ç çš„æç®€ä¸»ä¹‰ LLM æ¡†æ¶ã€‚

- **è½»é‡çº§**ï¼šä»… 100 è¡Œä»£ç ã€‚é›¶è‡ƒè‚¿ï¼Œé›¶ä¾èµ–ï¼Œé›¶ä¾›åº”å•†é”å®šã€‚
- **è¡¨è¾¾åŠ›å¼º**ï¼šåŒ…å«ä½ å–œçˆ±çš„ä¸€åˆ‡â€”(å¤š-)æ™ºèƒ½ä½“ï¼Œå·¥ä½œæµï¼ŒRAG ç­‰ç­‰ã€‚
- **æ™ºèƒ½ä½“ç¼–ç **ï¼šè®© AI æ™ºèƒ½ä½“ï¼ˆä¾‹å¦‚ Cursor AIï¼‰æ„å»ºæ™ºèƒ½ä½“â€”ç”Ÿäº§åŠ›æå‡ 10 å€ï¼

# 2. PocketFlow åŸºæœ¬ä»‹ç»

## 2.1. æ•´ä½“æ¶æ„

æ•´ä¸ªç³»ç»Ÿç”± **èŠ‚ç‚¹ï¼ˆNodeï¼‰** å’Œ **æµç¨‹ï¼ˆFlowï¼‰** æ„æˆï¼š

- **BaseNode**ï¼šæ‰€æœ‰èŠ‚ç‚¹çš„åŸºç±»ï¼Œå®šä¹‰äº† prep â†’ exec â†’ post ä¸‰é˜¶æ®µç”Ÿå‘½å‘¨æœŸã€‚
- **Node**ï¼šå¸¦é‡è¯•æœºåˆ¶çš„åŒæ­¥èŠ‚ç‚¹ã€‚
- **BatchNode**ï¼šå¯¹ä¸€æ‰¹è¾“å…¥é€ä¸ªä¸²è¡Œæ‰§è¡Œã€‚
- **Flow**ï¼šæ§åˆ¶å¤šä¸ªèŠ‚ç‚¹æŒ‰å›¾æ‰§è¡Œï¼ˆæ”¯æŒæ¡ä»¶è·³è½¬ï¼‰ã€‚
- **Async* ç³»åˆ—**ï¼šå¼‚æ­¥ç‰ˆæœ¬ï¼Œæ”¯æŒ async/awaitã€‚
- **AsyncParallelBatch***ï¼šåˆ©ç”¨ asyncio.gather å¹¶å‘æ‰§è¡Œæ‰¹é‡ä»»åŠ¡ã€‚

## 2.2. å…³é”®ç±»è¯¦è§£

### 2.2.1. BaseNode

**æ ¸å¿ƒæ–¹æ³•**ï¼š
- `prep(shared)`ï¼šå‡†å¤‡é˜¶æ®µï¼ˆå¦‚åŠ è½½é…ç½®ï¼‰
- `exec(prep_res)`ï¼šä¸»é€»è¾‘
- `post(shared, prep_res, exec_res)`ï¼šåå¤„ç†ï¼Œè¿”å› action å­—ç¬¦ä¸²ï¼ˆç”¨äºæµç¨‹è·³è½¬ï¼‰

**æ‰§è¡Œå…¥å£**ï¼š
`run(shared) â†’ è°ƒç”¨ _run() â†’ ä¾æ¬¡æ‰§è¡Œä¸‰é˜¶æ®µ`

**ç¼–æ’è¯­æ³•**ï¼š
- `node1 >> node2` â†’ ç­‰ä»·äº `node1.next(node2)`
- `node1 - "error" >> node3` â†’ æ¡ä»¶è·³è½¬ï¼ˆéœ€ post() è¿”å› "error"ï¼‰

### 2.2.2. Node (å¸¦é‡è¯•æœºåˆ¶)

**é‡è¯•é€»è¾‘**ï¼š
```python
for retry in range(max_retries):
    try: 
        return exec()
    except:
        if last_retry: 
            return exec_fallback()  # å¯è‡ªå®šä¹‰é™çº§
        time.sleep(wait)
```

**ç”¨é€”**ï¼šé€‚åˆå¯èƒ½å¤±è´¥çš„æ“ä½œï¼ˆå¦‚ç½‘ç»œè¯·æ±‚ã€æ¨¡å‹æ¨ç†ï¼‰ã€‚

### 2.2.3. BatchNode

**åŠŸèƒ½**ï¼šå¯¹ä¸€æ‰¹è¾“å…¥é€ä¸ªä¸²è¡Œæ‰§è¡Œï¼Œæ¯ä¸ªå…ƒç´ çš„æ‰§è¡Œç»“æœä¼šç´¯åŠ åˆ° `shared["batch_res"]` ä¸­ã€‚

**ç”¨é€”**ï¼šæ‰¹é‡å¤„ç†æ•°æ®ï¼ˆå¦‚æ‰¹é‡æ¨ç†ã€æ‰¹é‡æ•°æ®åº“æ“ä½œï¼‰ã€‚

### 2.2.4. Flowï¼ˆåŒæ­¥æµç¨‹æ§åˆ¶å™¨ï¼‰

**æ‰§è¡Œå¼•æ“ `_orch`**ï¼š
```python
curr = start_node
while curr:
    action = curr._run(shared)      # æ‰§è¡Œå½“å‰èŠ‚ç‚¹
    curr = get_next_node(curr, action)  # æ ¹æ® post() è¿”å›çš„ action è·³è½¬
```

**æ¡ä»¶è·³è½¬**ï¼š
- èŠ‚ç‚¹ `post()` è¿”å› "success" â†’ è·³è½¬åˆ° `successors["success"]`
- é»˜è®¤è·³è½¬ `successors["default"]`

**å‚æ•°ä¼ é€’**ï¼šæ¯ä¸ªèŠ‚ç‚¹å¯æ¥æ”¶ paramsï¼ˆæ¥è‡ª Flow çš„ params æˆ–æ‰¹é‡é¡¹ï¼‰

### 2.2.5. BatchFlow

**è¡Œä¸º**ï¼š`prep()` è¿”å›ä¸€æ‰¹å‚æ•°ï¼ˆå¦‚ `[{"model": "A"}, {"model": "B"}]`ï¼‰

å¯¹æ¯ç»„å‚æ•°ç‹¬ç«‹è¿è¡Œä¸€æ¬¡å®Œæ•´ Flowï¼š
```python
for bp in batch_params:
    self._orch(shared, {**global_params, **bp})
```

### 2.2.6. AsyncNode åŠå¼‚æ­¥å®¶æ—

- æ‰€æœ‰æ–¹æ³•æä¾› async ç‰ˆæœ¬ï¼ˆ`prep_async`, `exec_async` ç­‰ï¼‰
- `_exec` ä½¿ç”¨ `await asyncio.sleep` å®ç°å¼‚æ­¥é‡è¯•
- `run_async()` æ˜¯å…¥å£ï¼Œ`_run()` æŠ›å¼‚å¸¸ï¼ˆå¼ºåˆ¶ç”¨å¼‚æ­¥ï¼‰

**AsyncParallelBatchNode**ï¼š
```python
async def _exec(self, items):
    return await asyncio.gather(*[super()._exec(i) for i in items])
```
- ğŸ”„ å¹¶å‘æ‰§è¡Œæ‰€æœ‰ itemï¼ˆé€‚åˆ I/O å¯†é›†å‹ä»»åŠ¡ï¼‰

**AsyncParallelBatchFlow**ï¼š
- ğŸ”„ å¹¶å‘æ‰§è¡Œå¤šä¸ªç‹¬ç«‹ Flow å®ä¾‹