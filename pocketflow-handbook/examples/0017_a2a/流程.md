# 0017_a2a项目代码与流程梳理

## 项目概述

0017_a2a项目是一个基于A2A（Agent-to-Agent）协议的PocketFlow研究助手实现，它将PocketFlow的研究代理功能包装为A2A兼容的服务，使其能够通过标准化的A2A协议与其他系统进行交互。该项目主要用于回答用户问题，并在需要时通过网络搜索获取最新信息。

## 项目架构

项目采用分层架构设计，分为以下几个主要部分：

### 1. PocketFlow核心功能层

这是代理的核心逻辑部分，负责实际的问题处理和回答生成：

- **main.py**: 提供简单的命令行接口，用于直接测试PocketFlow功能
- **flow.py**: 定义和构建代理的工作流程，连接各个功能节点
- **nodes.py**: 包含三个核心节点实现（决策、搜索、回答）
- **utils.py**: 提供工具函数（调用大语言模型、网络搜索）

### 2. A2A通信层

这一层负责将PocketFlow功能包装为A2A兼容的服务：

- **a2a_server.py**: 创建和启动A2A服务器
- **a2a_client.py**: 提供与A2A服务器通信的客户端
- **task_manager.py**: 管理任务执行，连接A2A协议和PocketFlow核心
- **common/**: 包含A2A协议的通用实现（类型定义、客户端、服务器）

## 核心组件详解

### 1. PocketFlow研究代理

#### 工作流程（flow.py）

```python
def create_agent_flow():
    # 创建三个核心节点
    decide = DecideAction()
    search = SearchWeb()
    answer = AnswerQuestion()
    
    # 连接节点形成流程
    decide - "search" >> search    # 决定搜索时转到SearchWeb节点
    decide - "answer" >> answer    # 决定回答时转到AnswerQuestion节点
    search - "decide" >> decide    # 搜索完成后返回DecideAction节点
    
    return Flow(start=decide)      # 以DecideAction节点开始流程
```

#### 节点实现（nodes.py）

1. **DecideAction节点**
   - **prep**: 准备上下文和问题
   - **exec**: 调用LLM决定是搜索还是回答
   - **post**: 保存决策结果并确定下一步

2. **SearchWeb节点**
   - **prep**: 获取搜索查询
   - **exec**: 执行网络搜索
   - **post**: 保存搜索结果并返回决策节点

3. **AnswerQuestion节点**
   - **prep**: 获取问题和上下文
   - **exec**: 调用LLM生成最终答案
   - **post**: 保存答案并完成流程

### 2. A2A通信实现

#### 服务器端（a2a_server.py）

- 初始化并配置AgentCard，定义代理能力和技能
- 创建PocketFlowTaskManager实例处理任务
- 启动A2A服务器监听请求

#### 任务管理器（task_manager.py）

- 实现`on_send_task`方法处理非流式任务请求
- 从A2A请求中提取用户查询
- 调用PocketFlow流程执行研究
- 将结果打包为A2A兼容格式返回

#### 客户端（a2a_client.py）

- 创建与A2A服务器的连接
- 提供交互式命令行界面接收用户输入
- 构造并发送A2A请求
- 解析和展示服务器响应

### 3. 数据结构（common/types.py）

定义了A2A协议所需的核心数据类型：

- **TaskState**: 任务状态枚举（提交、工作中、完成等）
- **Message/Part**: 消息结构，支持文本、文件等不同类型的内容
- **Task**: 任务定义，包含ID、状态、结果等
- **JSONRPC相关类型**: 实现JSON-RPC 2.0协议

## 完整工作流程

当用户通过A2A客户端提问时，整个流程如下：

1. **客户端请求处理**
   - 用户在客户端输入问题
   - a2a_client.py构造A2A请求并发送到服务器

2. **服务器接收与处理**
   - a2a_server.py接收请求并交给PocketFlowTaskManager处理
   - task_manager.py从请求中提取问题文本

3. **PocketFlow执行研究**
   - 创建并运行agent_flow（从create_agent_flow()获取）
   - DecideAction节点决定是否需要搜索
   - 如果需要搜索，SearchWeb节点执行网络搜索并更新上下文
   - 搜索后再次回到DecideAction评估是否需要更多信息
   - 当决定可以回答时，AnswerQuestion节点生成最终答案

4. **结果返回**
   - task_manager.py将PocketFlow生成的答案打包为A2A格式
   - 通过A2A协议将结果返回给客户端
   - 客户端展示最终答案给用户

## 主要技术特点

1. **基于PocketFlow的工作流设计**：使用节点和连接构建灵活的研究代理流程
2. **决策循环机制**：实现了"决定-搜索-再决定"的迭代研究模式
3. **A2A协议兼容**：支持标准的Agent-to-Agent通信协议
4. **异步通信支持**：服务器和客户端均支持异步操作
5. **错误处理与状态跟踪**：完善的错误处理和任务状态管理

## 使用方法

1. **直接使用PocketFlow功能**：
   ```bash
   python main.py --Who won the Nobel Prize in Physics 2024?
   ```

2. **启动A2A服务器**：
   ```bash
   python a2a_server.py --host localhost --port 10003
   ```

3. **使用A2A客户端连接**：
   ```bash
   python a2a_client.py --agent-url http://localhost:10003
   ```

通过这种设计，0017_a2a项目成功地将PocketFlow的研究代理能力通过标准化的A2A协议暴露给其他系统，实现了代理之间的互操作性。
        